<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading Dashboard - Multi-Model Comparison</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .neutral { color: #9ca3af; }

        .card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
        }

        .account-card:hover {
            transform: translateY(-2px);
            transition: all 0.2s;
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }
        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #000; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: #fff; }
        .rank-4 { background: #374151; color: #9ca3af; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">AI Trading Dashboard</h1>
                <p class="text-slate-400 mt-1">Multi-Model Crypto Trading Comparison</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-sm text-slate-400">
                    <span class="pulse-dot w-2 h-2 bg-green-500 rounded-full"></span>
                    <span>Live</span>
                </div>
                <div id="lastUpdate" class="text-sm text-slate-400">
                    Last update: --
                </div>
                <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Total Portfolio Value</div>
                <div id="totalValue" class="text-2xl font-bold">$--</div>
            </div>
            <div class="card rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Total Daily P&L</div>
                <div id="totalPnL" class="text-2xl font-bold">$--</div>
            </div>
            <div class="card rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Daily P&L %</div>
                <div id="totalPnLPct" class="text-2xl font-bold">--%</div>
            </div>
            <div class="card rounded-xl p-6">
                <div class="text-slate-400 text-sm mb-1">Active Accounts</div>
                <div id="activeAccounts" class="text-2xl font-bold">--</div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="card rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Cumulative Performance</h2>
            <div class="relative" style="height: 400px;">
                <canvas id="performanceChart"></canvas>
            </div>
            <div id="chartLoading" class="absolute inset-0 flex items-center justify-center">
                <div class="text-slate-400">Loading chart data...</div>
            </div>
        </div>

        <!-- Account Ranking -->
        <div class="card rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Performance Ranking (Daily P&L)</h2>
            <div id="accountRanking" class="space-y-3">
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
                <div class="skeleton h-16 rounded-lg"></div>
            </div>
        </div>

        <!-- Account Details Grid -->
        <h2 class="text-xl font-semibold mb-4">Account Details</h2>
        <div id="accountCards" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card rounded-xl p-6 skeleton h-80"></div>
            <div class="card rounded-xl p-6 skeleton h-80"></div>
            <div class="card rounded-xl p-6 skeleton h-80"></div>
            <div class="card rounded-xl p-6 skeleton h-80"></div>
        </div>

        <!-- Trading History -->
        <div class="card rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Trading History</h2>

            <!-- Model Tabs -->
            <div id="orderTabs" class="flex gap-2 mb-4 flex-wrap">
                <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-700 text-white" data-account="all" onclick="switchOrderTab('all')">
                    All Models
                </button>
            </div>

            <!-- Orders Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-slate-400 border-b border-slate-700">
                            <th class="text-left py-3 px-2">Model</th>
                            <th class="text-left py-3 px-2">Symbol</th>
                            <th class="text-left py-3 px-2">Side</th>
                            <th class="text-right py-3 px-2">Qty</th>
                            <th class="text-right py-3 px-2">Price</th>
                            <th class="text-right py-3 px-2">Value</th>
                            <th class="text-left py-3 px-2">Status</th>
                            <th class="text-left py-3 px-2">Time</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="8" class="py-8 text-center text-slate-500">Loading orders...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="noOrdersMessage" class="hidden text-center py-8 text-slate-500">
                No trading history yet
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-slate-500 text-sm">
            <p>Auto-refresh every <span id="refreshInterval">{{ refresh_interval }}</span> seconds</p>
        </div>
    </div>

    <script>
        const REFRESH_INTERVAL = {{ refresh_interval }} * 1000;
        let refreshTimer = null;

        function formatCurrency(value) {
            if (value === null || value === undefined) return '$--';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '--%';
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(2)}%`;
        }

        function getPnLClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return 'neutral';
        }

        function formatTime(isoString) {
            if (!isoString || isoString === 'N/A') return 'N/A';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString();
            } catch {
                return isoString;
            }
        }

        function getRankBadge(rank) {
            if (!rank) return '';
            const classes = {
                1: 'rank-1',
                2: 'rank-2',
                3: 'rank-3',
                4: 'rank-4'
            };
            const icons = {
                1: '1',
                2: '2',
                3: '3',
                4: '4'
            };
            return `<div class="rank-badge ${classes[rank] || 'rank-4'}">${icons[rank] || rank}</div>`;
        }

        function createRankingRow(account) {
            if (account.status !== 'active') {
                return `
                    <div class="flex items-center gap-4 p-4 bg-slate-800/30 rounded-lg opacity-50">
                        <div class="rank-badge rank-4">-</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${account.name}</span>
                                <span class="text-slate-500">${account.error || 'Not configured'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            const pnlClass = getPnLClass(account.daily_pnl);
            const barWidth = Math.min(Math.abs(account.daily_pnl_pct) * 10, 100);
            const barColor = account.daily_pnl >= 0 ? 'bg-green-500' : 'bg-red-500';

            return `
                <div class="flex items-center gap-4 p-4 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition cursor-pointer"
                     style="border-left: 4px solid ${account.color}"
                     onclick="showAccountDetails('${account.id}')">
                    ${getRankBadge(account.rank)}
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium">${account.name}</span>
                            <span class="${pnlClass} font-bold text-lg">${formatPercent(account.daily_pnl_pct)}</span>
                        </div>
                        <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div class="${barColor} h-full rounded-full transition-all duration-500" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                    <div class="text-right min-w-[120px]">
                        <div class="${pnlClass} font-semibold">${formatCurrency(account.daily_pnl)}</div>
                        <div class="text-slate-500 text-sm">${formatCurrency(account.portfolio_value)}</div>
                    </div>
                </div>
            `;
        }

        function createAccountCard(account) {
            if (account.status !== 'active') {
                return `
                    <div class="card account-card rounded-xl p-6 opacity-50" style="border-top: 4px solid ${account.color}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold">${account.name}</h3>
                                <span class="text-xs text-red-400">Not Active</span>
                            </div>
                        </div>
                        <div class="text-slate-500 text-center py-8">
                            ${account.error || 'Account not configured'}
                        </div>
                    </div>
                `;
            }

            const pnlClass = getPnLClass(account.daily_pnl);
            const positions = account.positions || [];

            const positionsHtml = positions.length > 0
                ? positions.slice(0, 5).map(pos => {
                    const plClass = getPnLClass(pos.unrealized_pl);
                    return `
                        <div class="flex justify-between text-sm py-1">
                            <span class="text-slate-300">${pos.symbol}</span>
                            <span class="text-slate-400">${pos.qty.toFixed(4)}</span>
                            <span class="${plClass}">${formatCurrency(pos.unrealized_pl)}</span>
                        </div>
                    `;
                }).join('')
                : '<div class="text-slate-500 text-sm py-2">No positions</div>';

            return `
                <div class="card account-card rounded-xl p-6 cursor-pointer"
                     style="border-top: 4px solid ${account.color}"
                     onclick="showAccountDetails('${account.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">${account.name}</h3>
                            <span class="text-xs text-green-400">Active</span>
                        </div>
                        <div class="text-right">
                            <div class="${pnlClass} text-xl font-bold">${formatPercent(account.daily_pnl_pct)}</div>
                            <div class="text-slate-400 text-sm">${formatCurrency(account.daily_pnl)}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <div class="text-slate-400">Portfolio Value</div>
                            <div class="font-medium">${formatCurrency(account.portfolio_value)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400">Cash</div>
                            <div class="font-medium">${formatCurrency(account.cash)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400">Buying Power</div>
                            <div class="font-medium">${formatCurrency(account.buying_power)}</div>
                        </div>
                        <div>
                            <div class="text-slate-400">Unrealized P&L</div>
                            <div class="font-medium ${getPnLClass(account.total_unrealized_pl)}">${formatCurrency(account.total_unrealized_pl)}</div>
                        </div>
                    </div>

                    <div class="border-t border-slate-700 pt-3">
                        <div class="text-slate-400 text-xs mb-2">Positions (${account.position_count})</div>
                        <div class="space-y-1">
                            ${positionsHtml}
                        </div>
                        ${positions.length > 5 ? `<div class="text-slate-500 text-xs mt-2">+${positions.length - 5} more...</div>` : ''}
                    </div>

                    <div class="mt-4 pt-3 border-t border-slate-700 text-xs text-slate-500">
                        Updated: ${formatTime(account.last_updated)}
                    </div>
                </div>
            `;
        }

        function updateDashboard(data) {
            // Update summary cards
            const summary = data.summary || {};

            document.getElementById('totalValue').textContent = formatCurrency(summary.total_portfolio_value);

            const pnlEl = document.getElementById('totalPnL');
            pnlEl.textContent = formatCurrency(summary.total_daily_pnl);
            pnlEl.className = `text-2xl font-bold ${getPnLClass(summary.total_daily_pnl)}`;

            const pnlPctEl = document.getElementById('totalPnLPct');
            pnlPctEl.textContent = formatPercent(summary.total_daily_pnl_pct);
            pnlPctEl.className = `text-2xl font-bold ${getPnLClass(summary.total_daily_pnl_pct)}`;

            document.getElementById('activeAccounts').textContent = `${summary.active_accounts || 0} / ${summary.total_accounts || 4}`;
            document.getElementById('lastUpdate').textContent = `Last update: ${formatTime(data.timestamp)}`;

            // Update ranking
            const accounts = data.accounts || [];
            const rankingHtml = accounts.map(acc => createRankingRow(acc)).join('');
            document.getElementById('accountRanking').innerHTML = rankingHtml || '<div class="text-slate-500">No accounts</div>';

            // Update account cards
            const cardsHtml = accounts.map(acc => createAccountCard(acc)).join('');
            document.getElementById('accountCards').innerHTML = cardsHtml || '<div class="text-slate-500">No accounts</div>';
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Failed to fetch data:', error);
            }
        }

        function showAccountDetails(accountId) {
            window.open(`/api/account/${accountId}`, '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            refreshTimer = setInterval(refreshData, REFRESH_INTERVAL);
        });

        // Pause refresh when tab is not visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(refreshTimer);
            } else {
                refreshData();
                refreshTimer = setInterval(refreshData, REFRESH_INTERVAL);
            }
        });

        // Performance Chart
        let performanceChart = null;

        async function loadPerformanceChart() {
            try {
                const response = await fetch('/api/performance/history');
                const data = await response.json();
                renderPerformanceChart(data);
                document.getElementById('chartLoading').style.display = 'none';
            } catch (error) {
                console.error('Failed to load performance data:', error);
                document.getElementById('chartLoading').innerHTML = '<div class="text-slate-500">No performance data available yet</div>';
            }
        }

        function renderPerformanceChart(data) {
            const ctx = document.getElementById('performanceChart').getContext('2d');

            const datasets = [];

            // Add account lines
            for (const [accountId, accountData] of Object.entries(data.accounts || {})) {
                const points = accountData.data.map(d => ({
                    x: new Date(d.timestamp),
                    y: d.pnl_pct
                }));

                datasets.push({
                    label: accountData.name,
                    data: points,
                    borderColor: accountData.color,
                    backgroundColor: accountData.color + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                });
            }

            // Add benchmark line
            if (data.benchmark && data.benchmark.length > 0) {
                const benchmarkPoints = data.benchmark.map(d => ({
                    x: new Date(d.timestamp),
                    y: d.pnl_pct
                }));

                datasets.push({
                    label: 'Market (BTC+ETH Avg)',
                    data: benchmarkPoints,
                    borderColor: '#6b7280',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                });
            }

            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#94a3b8',
                                usePointStyle: true,
                                padding: 20,
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM d, HH:mm'
                                }
                            },
                            grid: {
                                color: '#334155',
                            },
                            ticks: {
                                color: '#64748b',
                            }
                        },
                        y: {
                            grid: {
                                color: '#334155',
                            },
                            ticks: {
                                color: '#64748b',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Load performance chart on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadPerformanceChart();
            // Refresh chart every 5 minutes
            setInterval(loadPerformanceChart, 5 * 60 * 1000);
        });

        // Trading History
        let ordersData = null;
        let currentOrderTab = 'all';

        async function loadOrderHistory() {
            try {
                const response = await fetch('/api/orders');
                ordersData = await response.json();
                updateOrderTabs();
                renderOrdersTable();
            } catch (error) {
                console.error('Failed to load order history:', error);
                document.getElementById('ordersTableBody').innerHTML =
                    '<tr><td colspan="8" class="py-8 text-center text-slate-500">Failed to load orders</td></tr>';
            }
        }

        function updateOrderTabs() {
            if (!ordersData || !ordersData.accounts) return;

            const tabsContainer = document.getElementById('orderTabs');
            let tabsHtml = `
                <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium ${currentOrderTab === 'all' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}"
                        data-account="all" onclick="switchOrderTab('all')">
                    All Models
                </button>
            `;

            for (const [accountId, accountData] of Object.entries(ordersData.accounts)) {
                const isActive = currentOrderTab === accountId;
                const orderCount = accountData.orders?.length || 0;
                tabsHtml += `
                    <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}"
                            style="border-left: 3px solid ${accountData.color}"
                            data-account="${accountId}" onclick="switchOrderTab('${accountId}')">
                        ${accountData.name} <span class="ml-1 text-xs opacity-70">(${orderCount})</span>
                    </button>
                `;
            }

            tabsContainer.innerHTML = tabsHtml;
        }

        function switchOrderTab(accountId) {
            currentOrderTab = accountId;
            updateOrderTabs();
            renderOrdersTable();
        }

        function formatOrderTime(isoString) {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return isoString;
            }
        }

        function getSideClass(side) {
            if (side && side.toLowerCase() === 'buy') return 'text-green-400';
            if (side && side.toLowerCase() === 'sell') return 'text-red-400';
            return 'text-slate-400';
        }

        function getStatusBadge(status) {
            const statusLower = (status || '').toLowerCase();
            let bgColor = 'bg-slate-600';
            if (statusLower === 'filled') bgColor = 'bg-green-600';
            else if (statusLower === 'canceled' || statusLower === 'cancelled') bgColor = 'bg-red-600';
            else if (statusLower === 'partially_filled') bgColor = 'bg-yellow-600';
            else if (statusLower === 'pending_new' || statusLower === 'new') bgColor = 'bg-blue-600';

            return `<span class="px-2 py-0.5 rounded text-xs ${bgColor}">${status || 'Unknown'}</span>`;
        }

        function renderOrdersTable() {
            if (!ordersData || !ordersData.accounts) return;

            const tbody = document.getElementById('ordersTableBody');
            const noOrdersMsg = document.getElementById('noOrdersMessage');

            // Collect orders to display
            let ordersToShow = [];

            if (currentOrderTab === 'all') {
                // Merge all orders from all accounts
                for (const [accountId, accountData] of Object.entries(ordersData.accounts)) {
                    for (const order of (accountData.orders || [])) {
                        ordersToShow.push({
                            ...order,
                            accountId,
                            accountName: accountData.name,
                            accountColor: accountData.color,
                        });
                    }
                }
                // Sort by filled_at descending
                ordersToShow.sort((a, b) => {
                    const timeA = a.filled_at || a.submitted_at || '';
                    const timeB = b.filled_at || b.submitted_at || '';
                    return timeB.localeCompare(timeA);
                });
                // Limit to 50 most recent
                ordersToShow = ordersToShow.slice(0, 50);
            } else {
                const accountData = ordersData.accounts[currentOrderTab];
                if (accountData) {
                    ordersToShow = (accountData.orders || []).map(order => ({
                        ...order,
                        accountId: currentOrderTab,
                        accountName: accountData.name,
                        accountColor: accountData.color,
                    }));
                }
            }

            if (ordersToShow.length === 0) {
                tbody.innerHTML = '';
                noOrdersMsg.classList.remove('hidden');
                return;
            }

            noOrdersMsg.classList.add('hidden');

            const rowsHtml = ordersToShow.map(order => `
                <tr class="border-b border-slate-700/50 hover:bg-slate-800/50">
                    <td class="py-3 px-2">
                        <span class="inline-block w-2 h-2 rounded-full mr-2" style="background-color: ${order.accountColor}"></span>
                        ${order.accountName}
                    </td>
                    <td class="py-3 px-2 font-medium">${order.symbol}</td>
                    <td class="py-3 px-2 ${getSideClass(order.side)} font-medium uppercase">${order.side}</td>
                    <td class="py-3 px-2 text-right">${order.filled_qty?.toFixed(4) || order.qty?.toFixed(4) || '-'}</td>
                    <td class="py-3 px-2 text-right">${order.filled_avg_price ? formatCurrency(order.filled_avg_price) : '-'}</td>
                    <td class="py-3 px-2 text-right">${order.notional ? formatCurrency(order.notional) : '-'}</td>
                    <td class="py-3 px-2">${getStatusBadge(order.status)}</td>
                    <td class="py-3 px-2 text-slate-400">${formatOrderTime(order.filled_at || order.submitted_at)}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rowsHtml;
        }

        // Load order history on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadOrderHistory();
            // Refresh orders every 30 seconds
            setInterval(loadOrderHistory, 30 * 1000);
        });
    </script>
</body>
</html>
